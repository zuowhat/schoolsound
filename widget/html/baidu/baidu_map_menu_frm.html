<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
</head>
<style type="text/css">
    body {
        background: #f4f4f4;
    }

    .aui-btn {
        padding-left: 8px;
        padding-right: 8px;
    }

    tr {
        background-color: #fff;
        width: 100%
    }
</style>

<body>
    <div class="aui-content">
        <div style="width:100%;">
            <table style="width:100%">
                <form>
                    <tr>
                        <td width="80px">我的位置:</td>
                        <td><input type="text" id="myLocation" style="height:30px" value="正在定位中……" /></td>
                    </tr>
                    <tr>
                        <td width="80px">终点位置:</td>
                        <td><input type="text" id="destLocation" tyle="height:30px" value="大蜀山" /></td>
                    </tr>
                </form>
            </table>
        </div>
        <div class="aui-tab" id="tab">
            <div class="aui-tab-item">公交</div>
            <div class="aui-tab-item  aui-active">驾车</div>
            <div class="aui-tab-item">步行</div>
        </div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/aui-tab.js"></script>
<script type="text/javascript">
    var cmap;
    var currentLon, currentLat;
    var destLat, destLon;
    apiready = function() {
        destLat = api.pageParam.destLat;
        destLon = api.pageParam.destLon;
        cmap = api.require('bMap');
        api.parseTapmode();
        getLocation();
    };

    var tab = new auiTab({
        element: document.getElementById("tab"),
        index: 2,
        repeatClick: false
    }, function(ret) {
        console.log(JSON.stringify(ret));
        if (ret.index == 1) {
            searchBmapRoute('transit', 'ebus_in_transfer')
        } else if (ret.index == 2) {
            searchBmapRoute('drive', 'ecar_time_first')
        } else {
            searchBmapRoute('walk', '')
        }
    });

    //获取坐标
    function getLocation() {
        cmap.getNameFromCoords({
            lon: destLon,
            lat: destLat
        }, function(ret) {
            if (ret.status) {
                document.getElementById("destLocation").value = ret.address;
            } else {
                document.getElementById("destLocation").value = "获取终点位置地址失败";
            }
        })
        cmap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                currentLat = ret.lat;
                currentLon = ret.lon;
                console.log(JSON.stringify(ret));
                cmap.getNameFromCoords({
                    lon: currentLon,
                    lat: currentLat
                }, function(ret, err) {
                    if (ret.status) {
                        document.getElementById("myLocation").value = ret.address;
                        searchBmapRoute('drive', 'ecar_time_first')
                    } else {
                        document.getElementById("myLocation").value = "获取当前位置失败";
                    }
                });
            } else {
                alert(err.code);
            }
        });
    }

    function searchBmapRoute(type, policy) {
        api.execScript({
            frameName: 'baidu_map_frm',
            script: "searchRoute('" + type + "'," + currentLat + "," + currentLon + "," + destLat + "," + destLon + ",'" + policy +"')"
        });
    }
</script>

</html>
