<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
</head>
<style type="text/css">
    body {
        background: #fff;
    }
</style>

<body>
    <div class="aui-content">
        <div style="width:100%; height:30px; background-color;#fff;vertical-align:middle;line-height:30px">
            <font style="font-weight:bold" id="policy"></font>
        </div>
        <div style="width:100%; height:40px;background-color:#f4f4f4;vertical-align:middle;line-height:40px">
            <font style="font-weight:" id="distanceAndTime"></font>
        </div>
        <div style="width:100%" id="resultList">
            <ul class="aui-list aui-list-in" id="resultListLi">
            </ul>
        </div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
    var destLat, destLon, startLon, startLat, dmap;
    apiready = function() {
        api.parseTapmode();
        destLat = api.pageParam.destLat;
        destLon = api.pageParam.destLon;
        dmap = api.require('bMap');
        dmap.getLocation(function(ret, err) {
            startLon = ret.lon;
            startLat = ret.lat;
        });
    }

    /**
     * @desc: 设置导航结果
     * @author: LCXU
     * @Date: 2018-11-26
     * @param: policy 出行方式
     * @param: ret 百度路线的结果
     */
    function setDaohangResult(policy, ret) {
        var policyHtml = $api.byId("policy");
        if (policy == "transit") {
            $api.html(policyHtml, "乘坐公共交通前往&nbsp;&nbsp;终点&nbsp;&nbsp;的路线&nbsp;&nbsp;<span style='padding-bottom:3px' style='margin-right:10px; height:26px; float:right' class='aui-btn aui-btn-info'  onclick='navigate(\"" + 'transit' + "\")'>导航</span>");
        } else if (policy == "drive") {
            $api.html(policyHtml, "驾车前往&nbsp;&nbsp;终点&nbsp;&nbsp;的路线&nbsp;&nbsp;<span style='margin-right:10px; height:26px; float:right'  class='aui-btn aui-btn-info aui-btn-sm'  onclick='navigate(\"" + 'driving' + "\")'>导航</span>");
        } else if (policy == "walk") {
            $api.html(policyHtml, "步行前往&nbsp;&nbsp;终点&nbsp;&nbsp;的路线&nbsp;&nbsp;<span style='margin-right:10px; height:26px; float:right' class='aui-btn aui-btn-info' onclick='navigate(\"" + 'walking' + "\")'>导航</span>");
        } else if (policy == "riding") {
            $api.html(policyHtml, "骑行前往&nbsp;&nbsp;终点&nbsp;&nbsp;的路线");
        }
        var retObj = JSON.parse(ret);
        if (retObj.status) {
            var distanceAndTime = $api.byId("distanceAndTime");
            var distance = retObj.plans[0].distance;
            var text = "全程约"
            if (distance > 1000) {
                distance = (distance / 1000).toFixed(1);
                text += distance + "千米,";
            } else {
                text += distance + "米,";
            }
            var min = retObj.plans[0].duration / 60;
            var hour = 0;
            if (min > 60) {
                hour = parseInt(min / 60);
                min = parseInt(min - (60 * hour));
            } else {
                min = parseInt(min);
            }
            text += "预计需要" + hour + "小时" + min + "分钟";
            $api.text(distanceAndTime, text);
            var nodes = retObj.plans[0].nodes
            var resListHtml = "";
            for (var i = 0; i < nodes.length; i++) {
                var number = i + 1;
                resListHtml += '<li class="aui-list-item">' +
                    '<div class="aui-list-item-inner">' +
                    '<div class="aui-list-item-title">' + number + ":" + nodes[i].description + '</div>' +
                    '</div>' +
                    '</li>';
            }
            var resultListLi = $api.byId("resultListLi");
            $api.html(resultListLi, resListHtml);
        }
    }

    /**
     * @desc: 导航，调用高德或者百度app
     * @author: LCXU
     * @Date: 2018-11-26
     * @param: mode 出行方式
     */
    function navigate(mode) {
        api.actionSheet({
            title: "请选择要打开的地图",
            cancelTitle: "取消",
            buttons: ['百度地图', '高德地图']
        }, function(ret, err) {
            if (ret) {
                var index = ret.buttonIndex;
                if (index == 1) {
                    bMapNavigate(mode);
                } else if (index == 2){
                    aMapNavigate(mode);
                }
            }
        });

    }

    /**
     * @desc: 调用百度导航
     * @author: LCXU
     * @Date: 2018-11-26
     * @param: mode 出行方式
     */
    function bMapNavigate(mode) {
        var appParam = {
            origin: 'latlng:' + startLat + ',' + startLon + '',
            destination: 'latlng:' + destLat + ',' + destLon + '',
            mode: mode,
            src: api.appName
        };
        console.log('intent://map/direction?latlng=' + startLon + ',' + startLat + '&mode=driving&destination= ' + destLon + ',' + destLat + '#Intent;scheme=bdapp;package=' + androidPkg + ';end');
        var androidPkg = "com.baidu.BaiduMap"
        api.openApp({
            androidPkg: 'android.intent.action.VIEW',
            appParam: appParam,
            mimeType: 'text/html',
            //uri: 'intent://map/direction?' + appParam + '&src=osm#Intent;scheme=bdapp;package=' + androidPkg + ';end',
            uri: 'intent://map/direction?latlng=' + startLat + ',' + startLon + '&mode=' + mode + '&destination=' + destLat + ',' + destLon + '#Intent;scheme=bdapp;package=' + androidPkg + ';end',
            iosUrl: 'baidumap://map/direction'
        }, function(ret, err) {
            if (ret) {
                console.log(ret);
            } else {
                console.log(err);
                api.toast({
                    msg: '应用无法打开，请确保安装了百度地图应用',
                    duration: 3000,
                    location: 'bottom'
                });
            }
        });
    }

    /**
     * @desc: 调用高德导航
     * @author: LCXU
     * @Date: 2018-11-26
     * @param: mode 出行方式
     */
    function aMapNavigate(mode) {
        //百度第一坐标转换为高德地图坐标
        var t = 0;
        if (mode == "transit") {
            t = 1;
        } else if(mode == "driving") {
            t = 0;
        } else {
            t = 2;
        }
        var orign, dest;
        convertCoordinate(startLon, startLat, function(locations) {
            orign = locations;
            convertCoordinate(destLon, destLat, function(locations) {
                dest = locations;
                //var uri = "androidamap://navi?amap.com/navigation?from="+orign+",startpoint&to=" + dest + ",endpoint&mode=car&src=" + api.appName;
                //var uri = "androidamap://navi?sourceApplication=" + api.appName + "&lat=36.547901&lon=104.258354&dev=0&style=2"
                var uri = "amapuri://route/plan?slat="+orign[1]+"&slon="+orign[0]+"&dlat="+dest[1]+"&dlon="+dest[0]+"&dev=1&t=" + t;
                console.log(uri);
                var appParam = {
                    androidPkg: 'com.autonavi.minimap',
                    slat: dest[1],
                    slon: dest[0],
                    dlat: dest[1],
                    dlon: dest[0],
                    dev: '1'
                };
                api.openApp({
                    androidPkg: 'android.intent.action.VIEW',
                    appParam: appParam,
                    //uri: 'intent://map/direction?' + appParam + '&src=osm#Intent;scheme=bdapp;package=' + androidPkg + ';end',
                    uri: uri,
                    iosUrl: 'iosamap://navi?'
                }, function(ret, err) {
                    if (ret) {
                        console.log(ret);
                    } else {
                        console.log(JSON.stringify(err));
                        api.toast({
                            msg: '应用无法打开，请确保安装了高德地图应用',
                            duration: 3000,
                            location: 'bottom'
                        });
                    }
                });
            });
        });
    }

    /**
     * @desc: 百度地图坐标转换为高德地图坐标
     * @author: LCXU
     * @Date: 2018-11-26
     * @param: lng  经度
     * @param: lat 纬度
     * @return： 转换后的经纬度地址[log, lat]
     */
    function convertCoordinate(lng, lat, callback) {
        api.ajax({
            url: 'https://restapi.amap.com/v3/assistant/coordinate/convert',
            method: 'post',
            data: {
                values: {
                    locations: lng + "," + lat,
                    coordsys: 'baidu',
                    output: 'JSON',
                    key: '6215ca87d8a46776f474feb9404963f4'
                }
            }
        },function(ret, err){
            if (ret) {
                var locations = ret.locations;
                callback(locations.split(","));
            } else {
                alert( JSON.stringify( err ) );
            }
        });

    }
</script>

</html>
