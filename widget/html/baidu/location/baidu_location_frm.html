<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../../../css/aui.css" />
</head>
<style type="text/css">
    body {
        background-color: #ffffff;
    }
</style>

<body>

</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript">
    var winHeight,map;
    var lat, lon;
    apiready = function() {
        winHeight = api.pageParam.height;
        lat = api.pageParam.destLat;
        lon = api.pageParam.destLon;
        var comeFrom = api.pageParam.comeFrom ? api.pageParam.comeFrom : '';
        api.parseTapmode();
        map = api.require('bMap');
        open();
        if (lat == "" && lon == "") {
            showUserLocation();
        } else {
            getNameFromCoords(lon, lat);
        }
        if (comeFrom != 'dcpy') {
            addEventListener();
        }
    //    getLocation();
    //    getNameFromCoords(lon,lat);
    //    autocomplete();
    };
    //打开地图
    function open() {
        map.open({
            rect: {
                x: 0,
                y: winHeight + 40,
                //y:200,
                w: 'auto',
                h: api.frameHeight
            },
            center: {
                lon: lon,
                lat: lat
            },
            zoomLevel: 15,
            showUserLocation: false,
            fixedOn: '',
            fixed: true
        }, function(ret) {

        });
    }

    /*
    *addAnnotations
    *添加标注信息
    */
    function addAnnotations(name , index , lonvalue , latvalue){
    	map.addAnnotations({
		    annotations: [{
		        id: index, lon: lonvalue, lat: latvalue
		    }],
		    icon: 'widget://image/mark.png',
		    draggable: true
		}, function(ret){
		    if(ret){
		    	//设置点击标注时弹出的气泡信息
		        map.setBubble({
				    id: ret.id,
				    bgImg: 'widget://image/mapbg.png',
				    content: {
				        title: index,
				        subTitle: name,
				        illus: 'widget://image/liulangnan2.jpg'
				    },
				    styles: {
				        titleColor: '#009900',
				        titleSize: 14,
				        subTitleColor: '#999',
				        subTitleSize: 12,
				        illusAlign: 'left'
				    }
				}, function(ret){
				    if(ret){
				        alert(JSON.stringify(ret));
				    }
				});
		    }
		});
    	map.setCenter({
		    coords: {
		        lon: lonvalue,
		        lat: latvalue
		    },
		    animation:false
		});
    }

    /*
     *根据坐标查找地址
     *获取我的坐标地址
     */
    function getNameFromCoords(lon, lat) {
        api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '定位中...',
            text: '请稍候...',
            modal: false
        });
        map.getNameFromCoords({
            lon: lon,
            lat: lat
        }, function(ret, err) {
            api.hideProgress();
            if (ret.status) {
                addAnnotations(ret.streeName , ret.address , lon , lat);
            }
        });
    }

    //获取坐标
    function getLocation() {
        map.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                lat = ret.lat;
                lon = ret.lon;
            } else {
                alert(err.code);
            }
        });
    }
    //根据地址查找坐标
    function getCoordsFromName(city, address, callback) {
        api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '定位中...',
            text: '请稍候...',
            modal: false
        });
        map.getCoordsFromName({
            city: city,
            address: address
        }, function(ret, err) {
            api.hideProgress();
            if (ret.status) {
                alert(JSON.stringify(ret));
                callback(ret)
            }
        });
    }

    /*
    *addEventListener
    *监听事件
    */
    function addEventListener(){
    	map.addEventListener({
		    name: 'click'
		},function(ret){
		    if(ret.status){
		        getNameFromCoords(JSON.stringify(ret.lon) , JSON.stringify(ret.lat));
                api.execScript({
                    frameName: 'baidu_location_result_frm',
                    script: 'getNameFromCoords(' + JSON.stringify(ret.lon) + ' , ' + JSON.stringify(ret.lat) + ');'
                });

		    }
		});
    }

    /*
     *setCenter
     *设置地图中心点
     */
    function setCenter(lon, lat) {
        api.toast({
            msg: '定位中',
            duration: 1500,
            location: 'top'
        });
        map.setCenter({
            coords: {
                lon: lon,
                lat: lat
            },
            animation: false
        });
    }
    /*
     *showUserLocation
     *显示用户位置
     */
    function showUserLocation() {
        api.toast({
            msg: '定位中',
            duration: 1500,
            location: 'top'
        });
        map.showUserLocation({
            isShow: true,
            trackingMode: 'none'
        });
        //缩放一下
        setZoomLevel(18);
    }
    /*
     *setZoomLevel
     *设置缩放等级
     */
    function setZoomLevel(level) {
        map.setZoomLevel({
            level: level
        });
    }
    /*
     *setRotation
     *设置旋转角度
     */
    function setRotation() {
        map.setRotation({
            degree: 90
        });
    }
    /*
     *setOverlook
     *设置俯视角度
     */
    function setOverlook() {
        map.setOverlook({
            degree: -30
        });
    }
    /*
     *setScaleBar
     *比例尺
     */
    function setScaleBar() {
        map.setScaleBar({
            show: true,
            position: {
                x: 0,
                y: 0
            }
        });
    }
    /*
     *setCompass
     *指南针位置
     */
    function setCompass() {
        map.setCompass({
            position: {
                x: 50,
                y: 50
            }
        });
    }
    /*
     *setTraffic
     *交通路况
     */
    function setTraffic() {
        map.setTraffic({
            traffic: true
        });
    }
    /*
     *setHeatMap
     *设置当前城市为热力图
     */
    function setHeatMap() {
        map.setHeatMap({
            heatMap: true
        });
        map.setZoomLevel({
            level: 13
        });
    }
    /*
     *setBuilding
     *是否显示3d
     */
    function setBuilding() {
        map.setBuilding({
            building: true
        });
        alert('设置成功，放大地图查看效果');
    }

    /*
     *searchInCity
     *根据单个关键字搜索兴趣点
     */
    function searchInCity(city , keyword) {
        api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '搜索中...',
            text: '请稍候...',
            modal: false
        });
        map.searchInCity({
            city: city,
            keyword: keyword,
            pageIndex: 0,
            pageCapacity: 20
        }, function(ret) {
            api.hideProgress();
            if (ret.status) {
                var results = ret.results;
                addAnnotations(results[1].name , results[1].address , results[1].lon , results[1].lat);
                map.setCenter({
                    coords: {
                        lon: results[1].lon,
                        lat: results[1].lat
                    },
                    animation: false
                });
                //alert(JSON.stringify(ret.results));
                //console.info(JSON.stringify(ret.results));
                api.execScript({
                    frameName: 'baidu_location_result_frm',
                    script: "setResult('" + JSON.stringify(ret.results) + "')"
                });
            } else {
                alert("请将地址填写的详细一点！");
            }
        });
    }
    /*
     *searchNearby
     *圆形区域内搜索兴趣点
     */
    function searchNearby() {
        map.searchNearby({
            keyword: '北京西站',
            lon: 116.384767,
            lat: 39.989539,
            radius: 2000
        }, function(ret, err) {
            if (ret.status) {
                alert(JSON.stringify(ret));
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    /*
     *autocomplete
     *根据关键字返回建议搜索关键字
     */
    function autocomplete() {
        map.autocomplete({
            keyword: '北京西站',
            city: '北京'
        }, function(ret) {
            if (ret.status) {
                alert(JSON.stringify(ret.results));
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
</script>

</html>
